'use strict';/*
 * adonis-session
 *
 * (c) Harminder Virk <virk@adonisjs.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */const _=require('lodash');const uuid=require('uuid');const debug=require('debug')('adonis:session');const GE=require('@adonisjs/generic-exceptions');const Store=require('./Store');const util=require('../../lib/util');class Session{constructor(_0x1cdfc4,_0x186f2b,_0x1f1e4b,_0x7a281d){const {options,key}=util['getCookieOption'](_0x7a281d);this['_request']=_0x1cdfc4;this['_response']=_0x186f2b;this['_driverInstance']=_0x1f1e4b;this['_isNewSessionId']=!![];this['_options']=options;this['_key']=key;this['_store']=null;this['_sessionId']=null;this['freezed']=![];}['_getSessionidFromToken'](){var _0xbf54cf={'sAoXs':function(_0x417baa,_0x5c9de1){return _0x417baa(_0x5c9de1);},'xuUry':'Env','ZOAxA':function(_0x22aae5,_0x34cb86){return _0x22aae5(_0x34cb86);},'jUInj':'jsonwebtoken','bpcTy':'JWT_SECRET','kxzAE':'token'};const _0x27029c=_0xbf54cf['sAoXs'](use,_0xbf54cf['xuUry']);const _0x26aab9=_0xbf54cf['ZOAxA'](require,_0xbf54cf['jUInj']);let _0x32cf95=_0x27029c['get'](_0xbf54cf['bpcTy']);const _0x252b03=this['_request']['header'](_0xbf54cf['kxzAE'])||this['_request']['get']()['token'];if(_0x252b03){let _0x4b089e=_0x26aab9['verify'](_0x252b03,_0x32cf95,function(_0x152e3b,_0x4494d8){if(_0x152e3b){return'';}else{return _0x4494d8['sessionid'];}});return _0x4b089e;}return'';}['getSessionId'](){return this['_sessionId'];}get['initiated'](){return!!this['_store'];}['_getSessionId'](){var _0x16f3a9={'fiBPm':function(_0x560482,_0x58f419){return _0x560482(_0x58f419);},'BtzDv':'existing\x20session\x20found\x20for\x20user'};const _0x2164b3=this['_getSessionidFromToken']();if(_0x2164b3){_0x16f3a9['fiBPm'](debug,_0x16f3a9['BtzDv']);this['_isNewSessionId']=![];return _0x2164b3;}return uuid['v4']();}['_touchSessionId'](_0x5a9ade){var _0x2664aa={'IgfCQ':function(_0x10a899,_0x4ec5f5){return _0x10a899(_0x4ec5f5);},'fXiTY':'touching\x20session\x20to\x20remain\x20active'};this['_sessionId']=_0x5a9ade;this['_response']['cookie'](this['_key'],_0x5a9ade,this['_options']);_0x2664aa['IgfCQ'](debug,_0x2664aa['fXiTY']);}['_ensureInitiated'](){var _0x2a4052={'PwNXz':'Session\x20store\x20is\x20not\x20initiated\x20yet.\x20Make\x20sure\x20that\x20you\x20have\x20included\x20the\x20session\x20middleware\x20inside\x20the\x20list\x20of\x20global\x20middleware.'};if(!this['initiated']){throw GE['RuntimeException']['invoke'](_0x2a4052['PwNXz']);}}['_ensureNotFreezed'](){var _0x168a48={'XhEZi':'Session\x20store\x20is\x20freezed\x20and\x20you\x20cannot\x20write\x20values\x20to\x20session.\x20This\x20usually\x20happens\x20during\x20the\x20Websocket\x20request'};if(this['freezed']){throw GE['RuntimeException']['invoke'](_0x168a48['XhEZi']);}}async['_getValues'](){var _0x20722d={'DCjFD':function(_0x4a6ef1,_0x3e22a0,_0x289beb){return _0x4a6ef1(_0x3e22a0,_0x289beb);},'GSOuw':'using\x20session\x20id\x20as\x20%s','ggQVc':function(_0x5d4d95,_0x585d17,_0x5066e8){return _0x5d4d95(_0x585d17,_0x5066e8);},'sNAbe':'fetch\x20driver\x20session\x20value\x20as\x20%j'};const _0x2da55b=this['_getSessionId']();_0x20722d['DCjFD'](debug,_0x20722d['GSOuw'],_0x2da55b);if(!this['freezed']){this['_touchSessionId'](_0x2da55b);}if(this['_isNewSessionId']){return new Store();}const _0x1d585d=await this['_driverInstance']['read'](_0x2da55b);_0x20722d['ggQVc'](debug,_0x20722d['sNAbe'],_0x1d585d);return new Store(_0x1d585d);}['_requestBody'](){var _0x2e89ad={'pCbNI':function(_0x476171,_0x1bbf84){return _0x476171===_0x1bbf84;},'uTxQj':'function'};return _0x2e89ad['pCbNI'](typeof this['_request']['original'],_0x2e89ad['uTxQj'])?this['_request']['original']():this['_request']['all']();}async['instantiate'](_0x52eaa4){this['freezed']=_0x52eaa4;this['_store']=await this['_getValues']();}async['commit'](){var _0x54c2a9={'WpCTw':function(_0x2747ee,_0x56c188){return _0x2747ee(_0x56c188);},'getIj':'saving\x20updates\x20to\x20session\x20driver','riaEY':function(_0x285140,_0x3edaa5){return _0x285140(_0x3edaa5);},'mhiOP':'touching\x20session\x20driver\x20to\x20keep\x20values\x20fresh'};if(this['_store']['isDirty']){_0x54c2a9['WpCTw'](debug,_0x54c2a9['getIj']);await this['_driverInstance']['write'](this['_sessionId'],JSON['stringify'](this['_store']['toJSON']()));}else{_0x54c2a9['riaEY'](debug,_0x54c2a9['mhiOP']);await this['_driverInstance']['touch'](this['_sessionId'],JSON['stringify'](this['_store']['toJSON']()));}}['put'](..._0x489557){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['put'](..._0x489557);}['get'](..._0x45bac6){this['_ensureInitiated']();return this['_store']['get'](..._0x45bac6);}['all'](..._0x4c6cd8){this['_ensureInitiated']();return this['_store']['all'](..._0x4c6cd8);}['forget'](..._0x359ff8){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['forget'](..._0x359ff8);}['pull'](..._0x537307){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['pull'](..._0x537307);}['increment'](..._0x282eb3){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['increment'](..._0x282eb3);}['decrement'](..._0x418efc){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['decrement'](..._0x418efc);}['clear'](){this['_ensureInitiated']();this['_ensureNotFreezed']();this['_store']['clear']();}['flashAll'](){this['_ensureNotFreezed']();return this['flash'](this['_requestBody']());}['flashOnly'](_0x59ee7f){this['_ensureNotFreezed']();return this['flash'](_['pick'](this['_requestBody'](),_0x59ee7f));}['flashExcept'](_0x422dd9){this['_ensureNotFreezed']();return this['flash'](_['omit'](this['_requestBody'](),_0x422dd9));}['withErrors'](_0x3547b8){this['_ensureNotFreezed']();return this['flash']({'errors':_0x3547b8});}['flash'](_0x5e79a6){var _0x288d4b={'ETaSe':'Flash\x20data\x20should\x20be\x20an\x20object','wBZuS':'__flash__'};if(!_['isPlainObject'](_0x5e79a6)){throw GE['InvalidArgumentException']['invalidParameter'](_0x288d4b['ETaSe'],_0x5e79a6);}const _0x270f8a=this['get'](_0x288d4b['wBZuS'],null);if(!_0x270f8a){this['put'](_0x288d4b['wBZuS'],_0x5e79a6);}else{_['merge'](_0x270f8a,_0x5e79a6);}return this;}}module['exports']=Session;