'use strict';/*
 * adonis-session
 *
 * (c) Harminder Virk <virk@adonisjs.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */const _=require('lodash');const uuid=require('uuid');const debug=require('debug')('adonis:session');const GE=require('@adonisjs/generic-exceptions');const Store=require('./Store');const util=require('../../lib/util');class Session{constructor(_0x45ff8e,_0x25451b,_0x1869ff,_0x18ff51){const {options,key}=util['getCookieOption'](_0x18ff51);this['_request']=_0x45ff8e;this['_response']=_0x25451b;this['_driverInstance']=_0x1869ff;this['_isNewSessionId']=!![];this['_options']=options;this['_key']=key;this['_store']=null;this['_sessionId']=null;this['freezed']=![];}['_getSessionidFromToken'](){var _0x4ac853={'RysxN':function(_0x41a6df,_0x4584fb){return _0x41a6df(_0x4584fb);},'peJdz':'Env','TclHl':function(_0x3826d6,_0x1abe15){return _0x3826d6(_0x1abe15);},'dqDnb':'jsonwebtoken','rTyqO':'JWT_SECRET','HBlop':'access_token'};const _0x2c44c2=_0x4ac853['RysxN'](use,_0x4ac853['peJdz']);const _0x48eafd=_0x4ac853['TclHl'](require,_0x4ac853['dqDnb']);let _0x3870d8=_0x2c44c2['get'](_0x4ac853['rTyqO']);const _0x478a33=this['_request']['header'](_0x4ac853['HBlop'])||this['_request']['get']()['access_token'];if(_0x478a33){let _0x25bb93=_0x48eafd['verify'](_0x478a33,_0x3870d8,function(_0x315bbd,_0x6312cd){if(_0x315bbd){return'';}else{return _0x6312cd['sessionid'];}});return _0x25bb93;}return'';}['getSessionId'](){return this['_sessionId'];}get['initiated'](){return!!this['_store'];}['_getSessionId'](){var _0x5a84c1={'BOcDv':function(_0x1c21f0,_0x98778f){return _0x1c21f0(_0x98778f);},'scSkC':'existing\x20session\x20found\x20for\x20user'};const _0x582e92=this['_getSessionidFromToken']();if(_0x582e92){_0x5a84c1['BOcDv'](debug,_0x5a84c1['scSkC']);this['_isNewSessionId']=![];return _0x582e92;}return uuid['v4']();}['_touchSessionId'](_0x3cc6f2){var _0x32a9eb={'zhwEg':function(_0x1d79dc,_0x352a9b){return _0x1d79dc(_0x352a9b);},'dEEME':'touching\x20session\x20to\x20remain\x20active'};this['_sessionId']=_0x3cc6f2;this['_response']['cookie'](this['_key'],_0x3cc6f2,this['_options']);_0x32a9eb['zhwEg'](debug,_0x32a9eb['dEEME']);}['_ensureInitiated'](){var _0x5c0c3f={'rNoPA':'Session\x20store\x20is\x20not\x20initiated\x20yet.\x20Make\x20sure\x20that\x20you\x20have\x20included\x20the\x20session\x20middleware\x20inside\x20the\x20list\x20of\x20global\x20middleware.'};if(!this['initiated']){throw GE['RuntimeException']['invoke'](_0x5c0c3f['rNoPA']);}}['_ensureNotFreezed'](){var _0x1cdfbe={'TGHkh':'Session\x20store\x20is\x20freezed\x20and\x20you\x20cannot\x20write\x20values\x20to\x20session.\x20This\x20usually\x20happens\x20during\x20the\x20Websocket\x20request'};if(this['freezed']){throw GE['RuntimeException']['invoke'](_0x1cdfbe['TGHkh']);}}async['_getValues'](){var _0x1d4630={'paZUN':function(_0x131bf0,_0x62d37b,_0x4d4753){return _0x131bf0(_0x62d37b,_0x4d4753);},'XKQbl':'using\x20session\x20id\x20as\x20%s','FWAAH':'fetch\x20driver\x20session\x20value\x20as\x20%j'};const _0x440de6=this['_getSessionId']();_0x1d4630['paZUN'](debug,_0x1d4630['XKQbl'],_0x440de6);if(!this['freezed']){this['_touchSessionId'](_0x440de6);}if(this['_isNewSessionId']){return new Store();}const _0x4e6fb3=await this['_driverInstance']['read'](_0x440de6);_0x1d4630['paZUN'](debug,_0x1d4630['FWAAH'],_0x4e6fb3);return new Store(_0x4e6fb3);}['_requestBody'](){var _0x50f7d8={'yCCsf':function(_0x5c5e5e,_0x3893e4){return _0x5c5e5e===_0x3893e4;},'KKLnG':'function'};return _0x50f7d8['yCCsf'](typeof this['_request']['original'],_0x50f7d8['KKLnG'])?this['_request']['original']():this['_request']['all']();}async['instantiate'](_0xe742c9){this['freezed']=_0xe742c9;this['_store']=await this['_getValues']();}async['commit'](){var _0x291852={'RmkUI':function(_0x3cc86d,_0x5cc58c){return _0x3cc86d(_0x5cc58c);},'uKplH':'saving\x20updates\x20to\x20session\x20driver','BZXRS':'touching\x20session\x20driver\x20to\x20keep\x20values\x20fresh'};if(this['_store']['isDirty']){_0x291852['RmkUI'](debug,_0x291852['uKplH']);await this['_driverInstance']['write'](this['_sessionId'],JSON['stringify'](this['_store']['toJSON']()));}else{_0x291852['RmkUI'](debug,_0x291852['BZXRS']);await this['_driverInstance']['touch'](this['_sessionId'],JSON['stringify'](this['_store']['toJSON']()));}}['put'](..._0x2151ac){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['put'](..._0x2151ac);}['get'](..._0x9b5fb6){this['_ensureInitiated']();return this['_store']['get'](..._0x9b5fb6);}['all'](..._0x4ec36d){this['_ensureInitiated']();return this['_store']['all'](..._0x4ec36d);}['forget'](..._0x14fb25){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['forget'](..._0x14fb25);}['pull'](..._0x26f207){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['pull'](..._0x26f207);}['increment'](..._0x269404){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['increment'](..._0x269404);}['decrement'](..._0x13b012){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['decrement'](..._0x13b012);}['clear'](){this['_ensureInitiated']();this['_ensureNotFreezed']();this['_store']['clear']();}['flashAll'](){this['_ensureNotFreezed']();return this['flash'](this['_requestBody']());}['flashOnly'](_0x194f85){this['_ensureNotFreezed']();return this['flash'](_['pick'](this['_requestBody'](),_0x194f85));}['flashExcept'](_0x22b0e7){this['_ensureNotFreezed']();return this['flash'](_['omit'](this['_requestBody'](),_0x22b0e7));}['withErrors'](_0x27f014){this['_ensureNotFreezed']();return this['flash']({'errors':_0x27f014});}['flash'](_0x509cec){var _0x5e897a={'qmLYN':'Flash\x20data\x20should\x20be\x20an\x20object','SkNmj':'__flash__'};if(!_['isPlainObject'](_0x509cec)){throw GE['InvalidArgumentException']['invalidParameter'](_0x5e897a['qmLYN'],_0x509cec);}const _0x3f360a=this['get'](_0x5e897a['SkNmj'],null);if(!_0x3f360a){this['put'](_0x5e897a['SkNmj'],_0x509cec);}else{_['merge'](_0x3f360a,_0x509cec);}return this;}}module['exports']=Session;