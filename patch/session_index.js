'use strict';
const _=require('lodash');const uuid=require('uuid');const debug=require('debug')('adonis:session');const GE=require('@adonisjs/generic-exceptions');const Store=require('./Store');const util=require('../../lib/util');class Session{constructor(_0x3e5f88,_0x1c2e00,_0x21f50a,_0x2bcf3b){const {options,key}=util['getCookieOption'](_0x2bcf3b);this['_request']=_0x3e5f88;this['_response']=_0x1c2e00;this['_driverInstance']=_0x21f50a;this['_isNewSessionId']=!![];this['_options']=options;this['_key']=key;this['_store']=null;this['_sessionId']=null;this['freezed']=![];}['_getSessionidFromToken'](){var _0x558678={'wWbGo':function(_0x1b372b,_0x57f0ca){return _0x1b372b(_0x57f0ca);},'SxqSm':'Env','QuUXR':'API_TOKEN_NAME','lVgbV':'token','SpIzp':function(_0xc80fda,_0x1127a5){return _0xc80fda(_0x1127a5);},'YIcvZ':'jsonwebtoken','JzJAZ':'JWT_SECRET'};const _0x41edbd=_0x558678['wWbGo'](use,_0x558678['SxqSm']);const _0x4fe6ec=_0x41edbd['get'](_0x558678['QuUXR'],_0x558678['lVgbV']);const _0x1abcc8=_0x558678['SpIzp'](require,_0x558678['YIcvZ']);let _0x29ef0e=_0x41edbd['get'](_0x558678['JzJAZ']);const _0x3b9d75=this['_request']['header'](_0x4fe6ec)||this['_request']['get']()[_0x4fe6ec];if(_0x3b9d75){let _0xe31439=_0x1abcc8['verify'](_0x3b9d75,_0x29ef0e,function(_0x11793c,_0x1e49b0){if(_0x11793c){return'';}else{return _0x1e49b0['sessionid'];}});return _0xe31439;}return'';}['getSessionId'](){return this['_sessionId'];}get['initiated'](){return!!this['_store'];}['_getSessionId'](){var _0x3556fa={'BydUz':function(_0x4d9a09,_0x2a56dc){return _0x4d9a09(_0x2a56dc);},'UqXkY':'existing\x20session\x20found\x20for\x20user'};const _0xf33cc3=this['_getSessionidFromToken']();if(_0xf33cc3){_0x3556fa['BydUz'](debug,_0x3556fa['UqXkY']);this['_isNewSessionId']=![];return _0xf33cc3;}return uuid['v4']();}['_touchSessionId'](_0x1e7997){var _0xa54cc9={'YCKYo':function(_0xed267d,_0x65c558){return _0xed267d(_0x65c558);},'PEPVU':'touching\x20session\x20to\x20remain\x20active'};this['_sessionId']=_0x1e7997;this['_response']['cookie'](this['_key'],_0x1e7997,this['_options']);_0xa54cc9['YCKYo'](debug,_0xa54cc9['PEPVU']);}['_ensureInitiated'](){var _0x13f93c={'VAWwT':'Session\x20store\x20is\x20not\x20initiated\x20yet.\x20Make\x20sure\x20that\x20you\x20have\x20included\x20the\x20session\x20middleware\x20inside\x20the\x20list\x20of\x20global\x20middleware.'};if(!this['initiated']){throw GE['RuntimeException']['invoke'](_0x13f93c['VAWwT']);}}['_ensureNotFreezed'](){var _0x237c79={'GlTCV':'Session\x20store\x20is\x20freezed\x20and\x20you\x20cannot\x20write\x20values\x20to\x20session.\x20This\x20usually\x20happens\x20during\x20the\x20Websocket\x20request'};if(this['freezed']){throw GE['RuntimeException']['invoke'](_0x237c79['GlTCV']);}}async['_getValues'](){var _0x3bbd7a={'GEaJA':function(_0x174665,_0x8db9c5,_0x2c26ab){return _0x174665(_0x8db9c5,_0x2c26ab);},'knxGo':'using\x20session\x20id\x20as\x20%s','ryght':'fetch\x20driver\x20session\x20value\x20as\x20%j'};const _0x1b2ca2=this['_getSessionId']();_0x3bbd7a['GEaJA'](debug,_0x3bbd7a['knxGo'],_0x1b2ca2);if(!this['freezed']){this['_touchSessionId'](_0x1b2ca2);}if(this['_isNewSessionId']){return new Store();}const _0x7caa3a=await this['_driverInstance']['read'](_0x1b2ca2);_0x3bbd7a['GEaJA'](debug,_0x3bbd7a['ryght'],_0x7caa3a);return new Store(_0x7caa3a);}['_requestBody'](){var _0x2ad22d={'gkPuJ':function(_0x2715e2,_0x19afae){return _0x2715e2===_0x19afae;},'cPmeq':'function'};return _0x2ad22d['gkPuJ'](typeof this['_request']['original'],_0x2ad22d['cPmeq'])?this['_request']['original']():this['_request']['all']();}async['instantiate'](_0x1a44b3){this['freezed']=_0x1a44b3;this['_store']=await this['_getValues']();}async['commit'](){var _0x27f928={'VSWik':function(_0x3a2126,_0x5e813a){return _0x3a2126(_0x5e813a);},'EMBLw':'saving\x20updates\x20to\x20session\x20driver','jrJOT':'touching\x20session\x20driver\x20to\x20keep\x20values\x20fresh'};if(this['_store']['isDirty']){_0x27f928['VSWik'](debug,_0x27f928['EMBLw']);await this['_driverInstance']['write'](this['_sessionId'],JSON['stringify'](this['_store']['toJSON']()));}else{_0x27f928['VSWik'](debug,_0x27f928['jrJOT']);await this['_driverInstance']['touch'](this['_sessionId'],JSON['stringify'](this['_store']['toJSON']()));}}['put'](..._0x575d17){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['put'](..._0x575d17);}['get'](..._0x325feb){this['_ensureInitiated']();return this['_store']['get'](..._0x325feb);}['all'](..._0x3bc3c5){this['_ensureInitiated']();return this['_store']['all'](..._0x3bc3c5);}['forget'](..._0x1977b4){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['forget'](..._0x1977b4);}['pull'](..._0x223c52){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['pull'](..._0x223c52);}['increment'](..._0x37ba49){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['increment'](..._0x37ba49);}['decrement'](..._0x47f336){this['_ensureInitiated']();this['_ensureNotFreezed']();return this['_store']['decrement'](..._0x47f336);}['clear'](){this['_ensureInitiated']();this['_ensureNotFreezed']();this['_store']['clear']();}['flashAll'](){this['_ensureNotFreezed']();return this['flash'](this['_requestBody']());}['flashOnly'](_0x2f2e0d){this['_ensureNotFreezed']();return this['flash'](_['pick'](this['_requestBody'](),_0x2f2e0d));}['flashExcept'](_0x5b88fe){this['_ensureNotFreezed']();return this['flash'](_['omit'](this['_requestBody'](),_0x5b88fe));}['withErrors'](_0xd18e19){this['_ensureNotFreezed']();return this['flash']({'errors':_0xd18e19});}['flash'](_0x4f75e5){var _0x5760b3={'rkcuN':'Flash\x20data\x20should\x20be\x20an\x20object','msAoU':'__flash__'};if(!_['isPlainObject'](_0x4f75e5)){throw GE['InvalidArgumentException']['invalidParameter'](_0x5760b3['rkcuN'],_0x4f75e5);}const _0x2d63da=this['get'](_0x5760b3['msAoU'],null);if(!_0x2d63da){this['put'](_0x5760b3['msAoU'],_0x4f75e5);}else{_['merge'](_0x2d63da,_0x4f75e5);}return this;}}module['exports']=Session;